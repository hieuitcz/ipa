name: Upload Any File

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'Direct URL to file'
        required: true
        type: string
      file_name:
        description: 'File name (with extension)'
        required: true
        type: string
      folder_path:
        description: 'Folder path (leave empty for root)'
        required: false
        type: string
        default: ''
      upload_method:
        description: 'Upload method'
        required: true
        type: choice
        options:
          - 'commit-to-repo'
          - 'github-release'
          - 'both'
        default: 'commit-to-repo'
      release_tag:
        description: 'Release tag (optional)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanitize inputs
        id: sanitize
        run: |
          FOLDER="${{ inputs.folder_path }}"
          FOLDER=$(echo "$FOLDER" | sed 's:^/*::; s:/*$::')

          TAG="${{ inputs.release_tag }}"
          if [ -z "$TAG" ]; then
            TAG=$(echo "${{ inputs.file_name }}" | sed 's/\.[^.]*$//' | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
            TAG="${TAG}-$(date +%Y%m%d-%H%M%S)"
          fi

          echo "folder=$FOLDER" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Download file
        run: |
          echo "üì• Downloading: ${{ inputs.file_url }}"
          curl -L -H "Accept: application/octet-stream" -o "temp_file" "${{ inputs.file_url }}"
          ls -lh temp_file

      - name: Get file info
        id: info
        run: |
          SIZE=$(stat -c%s "temp_file")
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT

      - name: Commit to repo
        if: inputs.upload_method == 'commit-to-repo' || inputs.upload_method == 'both'
        run: |
          FOLDER="${{ steps.sanitize.outputs.folder }}"
          if [ -n "$FOLDER" ]; then
            mkdir -p "$FOLDER"
            TARGET="$FOLDER/${{ inputs.file_name }}"
          else
            TARGET="${{ inputs.file_name }}"
          fi
          mv temp_file "$TARGET"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "$TARGET"
          git commit -m "üìÅ Upload ${{ inputs.file_name }}" || true
          git push

      - name: Upload to Release
        if: inputs.upload_method == 'github-release' || inputs.upload_method == 'both'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: temp_file
          asset_name: ${{ inputs.file_name }}
          tag: ${{ steps.sanitize.outputs.tag }}
          overwrite: true
