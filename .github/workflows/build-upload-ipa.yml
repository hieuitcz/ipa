name: Build and Upload IPA

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'Direct URL to IPA file'
        required: true
      app_name:
        description: 'App name'
        required: true
      version:
        description: 'Version number'
        required: true
      bundle_id:
        description: 'Bundle Identifier'
        required: true
      description:
        description: 'Version description (short)'
        required: false
        default: 'Latest version'
      full_description:
        description: 'Full app description'
        required: false
        default: 'Modified iOS application'
      icon_url:
        description: 'Icon URL (optional)'
        required: false
      tint_color:
        description: 'Tint color hex (without #, e.g. E36678)'
        required: false
        default: 'FF6B35'

permissions:
  contents: write

jobs:
  upload-ipa:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Generate valid tag name
        id: sanitize
        run: |
          # XÃ³a spaces, chuyá»ƒn thÃ nh hyphens, lowercase
          SAFE_TAG=$(echo "${{ inputs.app_name }}-${{ inputs.version }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          SAFE_FILENAME="${{ inputs.app_name }}-${{ inputs.version }}"
          
          # Generate icon filename
          ICON_NAME=$(echo "${{ inputs.app_name }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          
          echo "tag=$SAFE_TAG" >> $GITHUB_OUTPUT
          echo "filename=$SAFE_FILENAME" >> $GITHUB_OUTPUT
          echo "icon_name=$ICON_NAME" >> $GITHUB_OUTPUT
          
          echo "âœ… Tag: $SAFE_TAG"
          echo "âœ… Filename: $SAFE_FILENAME"
      
      - name: Download IPA
        run: |
          echo "ðŸ“¥ Downloading from: ${{ inputs.ipa_url }}"
          curl -L "${{ inputs.ipa_url }}" -o "app.ipa"
          ls -lh "app.ipa"
      
      - name: Get IPA size
        id: size
        run: |
          SIZE=$(stat -c%s "app.ipa")
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Size: $SIZE_MB MB ($SIZE bytes)"
      
      - name: Upload to Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: app.ipa
          asset_name: ${{ steps.sanitize.outputs.filename }}.ipa
          tag: ${{ steps.sanitize.outputs.tag }}
          release_name: ${{ inputs.app_name }} v${{ inputs.version }}
          overwrite: true
          body: |
            **${{ inputs.app_name }}** v${{ inputs.version }}
            
            ðŸ“¦ **Size:** ${{ steps.size.outputs.size_mb }} MB
            ðŸ”– **Bundle ID:** ${{ inputs.bundle_id }}
            ðŸ“¥ **Source:** ${{ inputs.ipa_url }}
            ðŸ“… **Uploaded:** ${{ github.event.repository.updated_at }}
            
            **Description:**
            ${{ inputs.description }}
            
            ---
            
            ### ðŸ“² Installation
            
            **ESign/GBox/Scarlet:**
            ```
            https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.tag }}/${{ steps.sanitize.outputs.filename }}.ipa
            ``````
            
            **AltStore:**
            ```
            altstore://install?url=https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.tag }}/${{ steps.sanitize.outputs.filename }}.ipa
            ```            ```
            
            **Direct:** [ðŸ“¥ Download](https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.tag }}/${{ steps.sanitize.outputs.filename }}.ipa)
      
      - name: Update apps.json (ESign format)
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          from datetime import datetime, timezone
          
          # Read inputs
          app_name = "${{ inputs.app_name }}"
          version = "${{ inputs.version }}"
          bundle_id = "${{ inputs.bundle_id }}"
          size = int("${{ steps.size.outputs.size }}")
          tag = "${{ steps.sanitize.outputs.tag }}"
          filename = "${{ steps.sanitize.outputs.filename }}"
          icon_name = "${{ steps.sanitize.outputs.icon_name }}"
          
          version_desc = "${{ inputs.description }}"
          full_desc = "${{ inputs.full_description }}"
          tint_color = "${{ inputs.tint_color }}"
          
          # Generate URLs
          download_url = f"https://github.com/${{ github.repository }}/releases/download/{tag}/{filename}.ipa"
          
          # Icon URL - use provided or default
          icon_url = "${{ inputs.icon_url }}"
          if not icon_url or icon_url == "":
              icon_url = f"https://raw.githubusercontent.com/${{ github.repository }}/main/icon/{icon_name}.jpg"
          
          # Current timestamp in ISO format
          version_date = datetime.now(timezone.utc).astimezone().isoformat()
          
          # Read or create apps.json
          try:
              with open('apps.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
          except FileNotFoundError:
              print("âš ï¸  apps.json not found, creating new one")
              data = {
                  "name": "Hieudz",
                  "identifier": "com.hieudz",
                  "sourceURL": f"https://github.com/${{ github.repository }}/raw/refs/heads/main/apps.json",
                  "apps": []
              }
          
          # Create new app entry (ESign format)
          new_app = {
              "name": app_name,
              "bundleIdentifier": bundle_id,
              "developerName": "hieudz",
              "version": version,
              "versionDate": version_date,
              "versionDescription": version_desc,
              "downloadURL": download_url,
              "localizedDescription": full_desc,
              "iconURL": icon_url,
              "tintColor": tint_color,
              "isLanZouCloud": 0,
              "size": size,
              "type": 1
          }
          
          # Find existing app by bundle ID
          app_index = next((i for i, a in enumerate(data['apps']) if a['bundleIdentifier'] == bundle_id), None)
          
          if app_index is not None:
              # Update existing app
              data['apps'][app_index] = new_app
              print(f"âœ… Updated {app_name} to v{version}")
          else:
              # Add new app
              data['apps'].append(new_app)
              print(f"âœ… Added new app: {app_name} v{version}")
          
          # Save with proper formatting
          with open('apps.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          
          print(f"ðŸ“ apps.json updated successfully")
          print(f"ðŸ“Š Total apps: {len(data['apps'])}")
          PYTHON_SCRIPT
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add apps.json
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            git commit -m "ðŸ¤– Update ${{ inputs.app_name }} v${{ inputs.version }}

          - Added/Updated ${{ inputs.app_name }} to v${{ inputs.version }}
          - Bundle ID: ${{ inputs.bundle_id }}
          - Size: ${{ steps.size.outputs.size_mb }} MB"
            git push
            echo "âœ… Changes pushed to repository"
          fi
