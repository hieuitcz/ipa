name: Build and Upload IPA

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'Direct URL to IPA file'
        required: true
      app_name:
        description: 'App name'
        required: true
      version:
        description: 'Version number'
        required: true
      bundle_id:
        description: 'Bundle Identifier'
        required: true
      description:
        description: 'Version description (short)'
        required: false
        default: 'Latest version'
      full_description:
        description: 'Full app description'
        required: false
        default: 'Modified iOS application'
      icon_url:
        description: 'Icon URL (optional)'
        required: false
      tint_color:
        description: 'Tint color hex (without #, e.g. E36678)'
        required: false
        default: 'FF6B35'

permissions:
  contents: write

jobs:
  upload-ipa:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Generate valid tag name
        id: sanitize
        run: |
          # XÃ³a spaces, chuyá»ƒn thÃ nh hyphens, lowercase
          SAFE_TAG=$(echo "${{ inputs.app_name }}-${{ inputs.version }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          SAFE_FILENAME="${{ inputs.app_name }}-${{ inputs.version }}"
          
          # Generate icon filename
          ICON_NAME=$(echo "${{ inputs.app_name }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          
          echo "tag=$SAFE_TAG" >> $GITHUB_OUTPUT
          echo "filename=$SAFE_FILENAME" >> $GITHUB_OUTPUT
          echo "icon_name=$ICON_NAME" >> $GITHUB_OUTPUT
          
          echo "âœ… Tag: $SAFE_TAG"
          echo "âœ… Filename: $SAFE_FILENAME"
      
      - name: Download IPA
        run: |
          echo "ðŸ“¥ Downloading from: ${{ inputs.ipa_url }}"
          curl -L "${{ inputs.ipa_url }}" -o "app.ipa"
          ls -lh "app.ipa"
      
      - name: Get IPA size
        id: size
        run: |
          SIZE=$(stat -c%s "app.ipa")
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Size: $SIZE_MB MB ($SIZE bytes)"
      
      - name: Upload to Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: app.ipa
          asset_name: ${{ steps.sanitize.outputs.filename }}.ipa
          tag: ${{ steps.sanitize.outputs.tag }}
          release_name: ${{ inputs.app_name }} v${{ inputs.version }}
          overwrite: true
          body: |
            **${{ inputs.app_name }}** v${{ inputs.version }}
            
            ðŸ“¦ **Size:** ${{ steps.size.outputs.size_mb }} MB
            ðŸ”– **Bundle ID:** ${{ inputs.bundle_id }}
            ðŸ“¥ **Source:** ${{ inputs.ipa_url }}
            ðŸ“… **Uploaded:** ${{ github.event.repository.updated_at }}
            
            **Description:**
            ${{ inputs.description }}
            
            ---
            
            ### ðŸ“² Installation
            
            **ESign/GBox/Scarlet:**
            ```
            https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.tag }}/${{ steps.sanitize.outputs.filename }}.ipa
            ```
            
            **Add to ESign:**
            ```
            https://raw.githubusercontent.com/${{ github.repository }}/main/esign.json
            ``````
            
            **Direct Download:** [ðŸ“¥ Click here](https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.tag }}/${{ steps.sanitize.outputs.filename }}.ipa)
      
      - name: Update esign.json
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          from datetime import datetime, timezone
          
          # Read inputs
          app_name = "${{ inputs.app_name }}"
          version = "${{ inputs.version }}"
          bundle_id = "${{ inputs.bundle_id }}"
          size = int("${{ steps.size.outputs.size }}")
          tag = "${{ steps.sanitize.outputs.tag }}"
          filename = "${{ steps.sanitize.outputs.filename }}"
          icon_name = "${{ steps.sanitize.outputs.icon_name }}"
          
          version_desc = "${{ inputs.description }}"
          full_desc = "${{ inputs.full_description }}"
          tint_color = "${{ inputs.tint_color }}"
          
          # Generate URLs
          download_url = f"https://github.com/${{ github.repository }}/releases/download/{tag}/{filename}.ipa"
          
          # Icon URL - use provided or default
          icon_url = "${{ inputs.icon_url }}"
          if not icon_url or icon_url == "":
              icon_url = f"https://raw.githubusercontent.com/${{ github.repository }}/main/icon/{icon_name}.jpg"
          
          # Current timestamp in ISO format
          version_date = datetime.now(timezone.utc).astimezone().isoformat()
          
          # Read or create esign.json
          try:
              with open('esign.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  print("âœ… Found existing esign.json")
          except FileNotFoundError:
              print("âš ï¸  esign.json not found, creating new one")
              data = {
                  "name": "hieuitcz/ipa",
                  "identifier": "com.hieuitcz.esign",
                  "sourceURL": f"https://raw.githubusercontent.com/${{ github.repository }}/main/esign.json",
                  "apps": []
              }
          
          # Ensure correct structure (in case file exists but has old format)
          data["name"] = "hieuitcz/ipa"
          data["identifier"] = "com.hieuitcz.esign"
          data["sourceURL"] = f"https://raw.githubusercontent.com/${{ github.repository }}/main/esign.json"
          
          # Create new app entry (ESign format)
          new_app = {
              "name": app_name,
              "bundleIdentifier": bundle_id,
              "developerName": "hieudz",
              "version": version,
              "versionDate": version_date,
              "versionDescription": version_desc,
              "downloadURL": download_url,
              "localizedDescription": full_desc,
              "iconURL": icon_url,
              "tintColor": tint_color,
              "isLanZouCloud": 0,
              "size": size,
              "type": 1
          }
          
          # Find existing app by bundle ID
          app_index = next((i for i, a in enumerate(data['apps']) if a['bundleIdentifier'] == bundle_id), None)
          
          if app_index is not None:
              # Update existing app
              data['apps'][app_index] = new_app
              print(f"âœ… Updated {app_name} to v{version}")
          else:
              # Add new app at the beginning
              data['apps'].insert(0, new_app)
              print(f"âœ… Added new app: {app_name} v{version}")
          
          # Save with proper formatting
          with open('esign.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          
          print(f"ðŸ“ esign.json updated successfully")
          print(f"ðŸ“Š Total apps: {len(data['apps'])}")
          print(f"ðŸ”— Source URL: {data['sourceURL']}")
          PYTHON_SCRIPT
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add esign.json
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            git commit -m "ðŸ¤– Update ${{ inputs.app_name }} v${{ inputs.version }}

          - Added/Updated ${{ inputs.app_name }} to v${{ inputs.version }}
          - Bundle ID: ${{ inputs.bundle_id }}
          - Size: ${{ steps.size.outputs.size_mb }} MB
          - Updated esign.json"
            git push
            echo "âœ… Changes pushed to repository"
            echo "ðŸ”— ESign source: https://raw.githubusercontent.com/${{ github.repository }}/main/esign.json"
          fi
```

## File esign.json Sáº½ CÃ³ Cáº¥u TrÃºc

```json```
{
  "name": "hieuitcz/ipa",
  "identifier": "com.hieuitcz.esign",
  "sourceURL": "https://raw.githubusercontent.com/hieuitcz/ipa/main/esign.json",
  "apps": [
    {
      "name": "YouTube Premium",
      "bundleIdentifier": "com.google.ios.youtube",
      "developerName": "hieudz",
      "version": "20.44.2",
      "versionDate": "2025-11-14T00:23:00+01:00",
      "versionDescription": "YouTube Plus v5.2b3\n\nAttempts to fix playback issues on sideload",
      "downloadURL": "https://github.com/hieuitcz/ipa/releases/download/youtube-premium-20.44.2/YouTube Premium-20.44.2.ipa",
      "localizedDescription": "This version contains YouTube Plus, YouPiP, YTUHD, Return YouTube Dislikes and Open in Safari extension...",
      "iconURL": "https://raw.githubusercontent.com/hieuitcz/esign/refs/heads/main/icon/youtube.jpg",
      "tintColor": "E36678",
      "isLanZouCloud": 0,
      "size": 115466859,
      "type": 1
    },
    {
      "name": "Aloha VPN",
      "bundleIdentifier": "com.alohabrowser.vpn",
      "developerName": "hieudz",
      "version": "2.2.1",
      "versionDate": "2025-11-14T00:23:00+01:00",
      "versionDescription": "Aloha VPN Premium â€“ Aloha VPN++ iPA by LÃª TÃ­",
      "downloadURL": "https://github.com/hieuitcz/ipa/releases/download/aloha-vpn-2.2.1/Aloha VPN-2.2.1.ipa",
      "localizedDescription": "Features:\n- Remove ads\n- Remove stories banner...",
      "iconURL": "https://raw.githubusercontent.com/hieuitcz/esign/refs/heads/main/icon/aloha.webp",
      "tintColor": "AF38EB",
      "isLanZouCloud": 0,
      "size": 73615608,
      "type": 1
    }
  ]
}
```

## Nhá»¯ng Thay Äá»•i

### 1. **File Name**
- âœ… `esign.json` (thay vÃ¬ apps.json)
- âœ… Táº¥t cáº£ references Ä‘Ã£ update

### 2. **Fixed Header Structure**
``````json
{
  "name": "hieuitcz/ipa",
  "identifier": "com.hieuitcz.esign",
  "sourceURL": "https://raw.githubusercontent.com/hieuitcz/ipa/main/esign.json"
}
```

### 3. **sourceURL Dynamic**
- Tá»± Ä‘á»™ng generate dá»±a trÃªn repository name
- Náº¿u repo lÃ  `hieuitcz/ipa` â†’ `https://raw.githubusercontent.com/hieuitcz/ipa/main/esign.json`

### 4. **Auto-update Structure**
- Má»—i láº§n run sáº½ Ä‘áº£m báº£o header structure Ä‘Ãºng
- Ngay cáº£ khi file Ä‘Ã£ tá»“n táº¡i vá»›i format cÅ©

## Add Source vÃ o ESign

