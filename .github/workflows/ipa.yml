name: Upload IPA to Release Only

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'Direct URL to IPA file'
        required: true
        type: string
      app_name:
        description: 'App Name'
        required: true
        type: string
      version:
        description: 'Version'
        required: true
        type: string
      bundle_id:
        description: 'Bundle Identifier'
        required: false
        type: string

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Sanitize names
        id: sanitize
        run: |
          SAFE_NAME=$(echo "${{ inputs.app_name }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          SAFE_TAG="${SAFE_NAME}-${{ inputs.version }}"
          FILE_NAME="${{ inputs.app_name }}-${{ inputs.version }}"
          
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "safe_tag=$SAFE_TAG" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
      
      - name: Download IPA
        run: |
          echo "ðŸ“¥ Downloading: ${{ inputs.ipa_url }}"
          curl -L -H "Accept: application/octet-stream" \
               -o "app.ipa" "${{ inputs.ipa_url }}"
          
          if ! file app.ipa | grep -q "Zip archive"; then
            echo "âŒ Not a valid IPA"
            exit 1
          fi
          
          ls -lh app.ipa
      
      - name: Get IPA size
        id: info
        run: |
          SIZE=$(stat -c%s "app.ipa")
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Size: $SIZE_MB MB"
      
      - name: Upload to Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: app.ipa
          asset_name: ${{ steps.sanitize.outputs.file_name }}.ipa
          tag: ${{ steps.sanitize.outputs.safe_tag }}
          release_name: ${{ inputs.app_name }} v${{ inputs.version }}
          overwrite: true
          body: |
            **${{ inputs.app_name }}** v${{ inputs.version }}
            
            ðŸ“¦ Size: ${{ steps.info.outputs.size_mb }} MB
            ðŸ”– Bundle ID: ${{ inputs.bundle_id }}
            ðŸ“¥ Source: ${{ inputs.ipa_url }}
            
            ### ðŸ“¥ Direct Download
            ```
            https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.safe_tag }}/${{ steps.sanitize.outputs.file_name }}.ipa
            ```
      
      - name: Update index only (no IPA file)
        run: |
          mkdir -p ipa
          
          python3 << 'EOF'
          import json
          from datetime import datetime
          
          index_file = "ipa/index.json"
          
          try:
              with open(index_file, 'r') as f:
                  index = json.load(f)
          except:
              index = {"apps": [], "lastUpdated": ""}
          
          app_entry = {
              "name": "${{ inputs.app_name }}",
              "safeName": "${{ steps.sanitize.outputs.safe_name }}",
              "version": "${{ inputs.version }}",
              "bundleId": "${{ inputs.bundle_id }}",
              "size": ${{ steps.info.outputs.size }},
              "sizeMB": "${{ steps.info.outputs.size_mb }}",
              "uploadDate": datetime.utcnow().isoformat() + "Z",
              "downloadURL": f"https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.safe_tag }}/${{ steps.sanitize.outputs.file_name }}.ipa",
              "releaseURL": f"https://github.com/${{ github.repository }}/releases/tag/${{ steps.sanitize.outputs.safe_tag }}"
          }
          
          existing = next((i for i, a in enumerate(index["apps"]) if a.get("safeName") == "${{ steps.sanitize.outputs.safe_name }}"), None)
          
          if existing is not None:
              index["apps"][existing] = app_entry
          else:
              index["apps"].insert(0, app_entry)
          
          index["lastUpdated"] = datetime.utcnow().isoformat() + "Z"
          
          with open(index_file, 'w') as f:
              json.dump(index, f, indent=2)
          
          print(f"âœ… Updated index - Total apps: {len(index['apps'])}")
          EOF
      
      - name: Commit index only
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add ipa/index.json
          
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“ Update index for ${{ inputs.app_name }} v${{ inputs.version }}"
            git push
            echo "âœ… Index updated"
          fi
          
          echo ""
          echo "ðŸŽ‰ SUCCESS!"
          echo "ðŸ“¥ Download URL:"
          echo "https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.safe_tag }}/${{ steps.sanitize.outputs.file_name }}.ipa"
```

## Giáº£i PhÃ¡p 2: DÃ¹ng Git LFS (Advanced)

Náº¿u báº¡n **thá»±c sá»± muá»‘n commit IPA vÃ o repo**, cáº§n setup Git LFS:

``````yaml
name: Upload IPA with Git LFS

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        required: true
      app_name:
        required: true
      version:
        required: true

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Setup Git LFS
        run: |
          git lfs install
          
          # Track IPA files náº¿u chÆ°a cÃ³
          if [ ! -f .gitattributes ] || ! grep -q "*.ipa" .gitattributes; then
            echo "*.ipa filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
            git add .gitattributes
            git commit -m "Setup Git LFS for IPA files" || true
            git push || true
          fi
      
      - name: Sanitize names
        id: sanitize
        run: |
          SAFE_NAME=$(echo "${{ inputs.app_name }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          FILE_NAME="${{ inputs.app_name }}-${{ inputs.version }}"
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
      
      - name: Download IPA
        run: |
          curl -L -H "Accept: application/octet-stream" \
               -o "temp.ipa" "${{ inputs.ipa_url }}"
          ls -lh temp.ipa
      
      - name: Move to ipa directory
        run: |
          mkdir -p ipa
          mv temp.ipa "ipa/${{ steps.sanitize.outputs.file_name }}.ipa"
      
      - name: Commit with LFS
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Git LFS sáº½ tá»± Ä‘á»™ng xá»­ lÃ½ file lá»›n
          git lfs track "ipa/*.ipa"
          git add ipa/
          git commit -m "ðŸ“¦ Add ${{ inputs.app_name }} v${{ inputs.version }} (LFS)"
          git push
```

**LÆ°u Ã½ vá» Git LFS:**
- Free tier: 1GB storage, 1GB bandwidth/month
- Paid: $5/month cho 50GB storage + 50GB bandwidth
- Link: https://docs.github.com/en/billing/managing-billing-for-git-large-file-storage

## Giáº£i PhÃ¡p 3: Hybrid (Recommended)

Upload **cáº£ Release asset VÃ€ external URL** (nhÆ° dvntm0 lÃ m):

```yaml```
name: Hybrid Upload

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        required: true
      app_name:
        required: true
      version:
        required: true
      external_host:
        description: 'External host for IPA (Dropbox/Drive link - optional)'
        required: false

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Sanitize
        id: sanitize
        run: |
          SAFE_NAME=$(echo "${{ inputs.app_name }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          SAFE_TAG="${SAFE_NAME}-${{ inputs.version }}"
          FILE_NAME="${{ inputs.app_name }}-${{ inputs.version }}"
          echo "safe_tag=$SAFE_TAG" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
      
      - name: Download IPA
        run: |
          curl -L -H "Accept: application/octet-stream" -o app.ipa "${{ inputs.ipa_url }}"
      
      - name: Get size
        id: info
        run: |
          SIZE=$(stat -c%s app.ipa)
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
      
      - name: Upload to Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: app.ipa
          asset_name: ${{ steps.sanitize.outputs.file_name }}.ipa
          tag: ${{ steps.sanitize.outputs.safe_tag }}
          release_name: ${{ inputs.app_name }} v${{ inputs.version }}
          overwrite: true
          body: |
            ðŸ“¦ ${{ inputs.app_name }} v${{ inputs.version }}
            Size: ${{ steps.info.outputs.size_mb }} MB
            
            Download: https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.safe_tag }}/${{ steps.sanitize.outputs.file_name }}.ipa
      
      - name: Update metadata
        run: |
          mkdir -p ipa
          
          # DÃ¹ng external URL náº¿u cÃ³, náº¿u khÃ´ng thÃ¬ dÃ¹ng Release URL
          DOWNLOAD_URL="${{ inputs.external_host }}"
          if [ -z "$DOWNLOAD_URL" ]; then
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.safe_tag }}/${{ steps.sanitize.outputs.file_name }}.ipa"
          fi
          
          cat > "ipa/${{ steps.sanitize.outputs.safe_tag }}.json" << EOF
          {
            "name": "${{ inputs.app_name }}",
            "version": "${{ inputs.version }}",
            "downloadURL": "$DOWNLOAD_URL",
            "size": ${{ steps.info.outputs.size }},
            "sizeMB": "${{ steps.info.outputs.size_mb }}"
          }
          EOF
      
      - name: Commit metadata only
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add ipa/*.json
          git commit -m "ðŸ“ Add metadata for ${{ inputs.app_name }}" || true
          git push
```
