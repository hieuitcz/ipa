name: Upload IPA to Release Only

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'Direct URL to IPA file'
        required: true
        type: string
      app_name:
        description: 'App Name'
        required: true
        type: string
      version:
        description: 'Version'
        required: true
        type: string
      bundle_id:
        description: 'Bundle Identifier'
        required: false
        type: string

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Sanitize names
        id: sanitize
        run: |
          SAFE_NAME=$(echo "${{ inputs.app_name }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          SAFE_TAG="${SAFE_NAME}-${{ inputs.version }}"
          FILE_NAME="${{ inputs.app_name }}-${{ inputs.version }}"
          
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "safe_tag=$SAFE_TAG" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
      
      - name: Download IPA
        run: |
          echo "ðŸ“¥ Downloading: ${{ inputs.ipa_url }}"
          curl -L -H "Accept: application/octet-stream" \
               -o "app.ipa" "${{ inputs.ipa_url }}"
          
          if ! file app.ipa | grep -q "Zip archive"; then
            echo "âŒ Not a valid IPA"
            exit 1
          fi
          
          ls -lh app.ipa
      
      - name: Get IPA size
        id: info
        run: |
          SIZE=$(stat -c%s "app.ipa")
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Size: $SIZE_MB MB"
      
      - name: Upload to Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: app.ipa
          asset_name: ${{ steps.sanitize.outputs.file_name }}.ipa
          tag: ${{ steps.sanitize.outputs.safe_tag }}
          release_name: ${{ inputs.app_name }} v${{ inputs.version }}
          overwrite: true
          body: |
            **${{ inputs.app_name }}** v${{ inputs.version }}
            
            ðŸ“¦ Size: ${{ steps.info.outputs.size_mb }} MB
            ðŸ”– Bundle ID: ${{ inputs.bundle_id }}
            ðŸ“¥ Source: ${{ inputs.ipa_url }}
            
            ### ðŸ“¥ Direct Download
            ```
            https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.safe_tag }}/${{ steps.sanitize.outputs.file_name }}.ipa
            ```
      
      - name: Update index only (no IPA file)
        run: |
          mkdir -p ipa
          
          python3 << 'EOF'
          import json
          from datetime import datetime
          
          index_file = "ipa/index.json"
          
          try:
              with open(index_file, 'r') as f:
                  index = json.load(f)
          except:
              index = {"apps": [], "lastUpdated": ""}
          
          app_entry = {
              "name": "${{ inputs.app_name }}",
              "safeName": "${{ steps.sanitize.outputs.safe_name }}",
              "version": "${{ inputs.version }}",
              "bundleId": "${{ inputs.bundle_id }}",
              "size": ${{ steps.info.outputs.size }},
              "sizeMB": "${{ steps.info.outputs.size_mb }}",
              "uploadDate": datetime.utcnow().isoformat() + "Z",
              "downloadURL": f"https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.safe_tag }}/${{ steps.sanitize.outputs.file_name }}.ipa",
              "releaseURL": f"https://github.com/${{ github.repository }}/releases/tag/${{ steps.sanitize.outputs.safe_tag }}"
          }
          
          existing = next((i for i, a in enumerate(index["apps"]) if a.get("safeName") == "${{ steps.sanitize.outputs.safe_name }}"), None)
          
          if existing is not None:
              index["apps"][existing] = app_entry
          else:
              index["apps"].insert(0, app_entry)
          
          index["lastUpdated"] = datetime.utcnow().isoformat() + "Z"
          
          with open(index_file, 'w') as f:
              json.dump(index, f, indent=2)
          
          print(f"âœ… Updated index - Total apps: {len(index['apps'])}")
          EOF
      
      - name: Commit index only
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add ipa/index.json
          
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“ Update index for ${{ inputs.app_name }} v${{ inputs.version }}"
            git push
            echo "âœ… Index updated"
          fi
          
          echo ""
          echo "ðŸŽ‰ SUCCESS!"
          echo "ðŸ“¥ Download URL:"
          echo "https://github.com/${{ github.repository }}/releases/download/${{ steps.sanitize.outputs.safe_tag }}/${{ steps.sanitize.outputs.file_name }}.ipa"
